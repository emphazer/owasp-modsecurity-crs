# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set ver.3.0.0
# Copyright (c) 2006-2016 Trustwave and contributors. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set is distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# These exclusions remedy false positives in a default Typo3 install.
# The exclusions are only active if crs_exclusions_typo3=1 is set.
# See rule 900130 in crs-setup.conf.example for instructions.

SecRule &TX:crs_exclusions_typo3|TX:crs_exclusions_typo3 "@eq 0" \
	"id:9003000,\
	phase:1,\
	t:none,\
	nolog,\
	pass,\
	skipAfter:END-TYPO3"

SecRule &TX:crs_exclusions_typo3|TX:crs_exclusions_typo3 "@eq 0" \
	"id:9003001,\
	phase:2,\
	t:none,\
	nolog,\
	pass,\
	skipAfter:END-TYPO3"


#
# -=[ Typo3 Front-End ]=-
#


# [ Password ]
#
# Disable the CRS completely for all occurrences of passwords.
#
SecRule REQUEST_FILENAME "@endsWith /typo3/sysext/install/Start/Install.php" \
        "id:9003110,\
        phase:1,\
        nolog,\
        pass,\
        ctl:ruleRemoveTargetByTag=CRS;ARGS:install[values][password]"


#
# [ Base Configuration ]
#
# Disable known false positives for various fields during the setup of the initial site
#        path /typo3/sysext/install/Start/Install.php
#
# ModSec Rule Exclusion: 921130 : HTTP Response Splitting Attack
# ModSec Rule Exclusion: 932150 : Remote Command Execution: Direct Unix Command Execution
# ModSec Rule Exclusion: 942100 : SQL Injection Attack Detected via libinjection
# ModSec Rule Exclusion: 942110 : SQL Injection Attack: Common Injection Testing Detected
# ModSec Rule Exclusion: 942430 : Restricted SQL Character Anomaly Detection (12)
#      
SecRule REQUEST_URI "@endsWith  /typo3/sysext/install/Start/Install.php" \
        "id:9003200,\
        phase:1,\
        nolog,\
        pass,\
        ctl:ruleRemoveTargetById=921130;ARGS:install[values][FE][pageNotFound_handling_statheader],\
        ctl:ruleRemoveTargetById=921130;ARGS:install[values][FE][pageUnavailable_handling_statheader],\
        ctl:ruleRemoveTargetById=932150;ARGS:install[values][MAIL][transport_sendmail_command],\
        ctl:ruleRemoveTargetById=932150;ARGS:install[values][Mail][Custom][MAIL/transport_sendmail_command],\
        ctl:ruleRemoveTargetById=942100;ARGS:install[values][GFX][processor_stripColorProfileCommand],\
        ctl:ruleRemoveTargetById=942110;ARGS:install[values][GFX][processor_stripColorProfileCommand],\
        ctl:ruleRemoveTargetById=942430;ARGS:install[values][BE][fileDenyPattern],\
        ctl:ruleRemoveTargetById=942430;ARGS:install[values][EXT][excludeForPackaging]"


# 
# ModSec Rule Exclusion: 953110 : PHP source code leakage
# When running in debug mode, there is PHP code returned to the client
#
SecRule REQUEST_URI "@streq /index.php" \
        "id:9003210,\
        phase:2,\
        nolog,\
        pass,\
        ctl:ruleRemoveTargetById=953110;RESPONSE_BODY"


#
# [ Admin (? FIXME) ]
# 
# Disable known false positives for various fields when in the admin gui (? FIXME)
#     path /typo3/index.php

# ModSec Rule Exclusion: 920230 : Multiple URL Encoding Detected
# ModSec Rule Exclusion: 932115 : Remote Command Execution: Windows Command Injection
# ModSec Rule Exclusion: 941320 : Possible XSS Attack Detected - HTML Tag Handler
# ModSec Rule Exclusion: 941340 : IE XSS Filters - Attack Detected.
# ModSec Rule Exclusion: 942130 : SQL Injection Attack: SQL Tautology Detected.
# ModSec Rule Exclusion: 942200 : Detects MySQL comment-/space-obfuscated injections and backtick termination
# ModSec Rule Exclusion: 942210 : Detects chained SQL injection attempts 1/2
# ModSec Rule Exclusion: 942260 : Detects basic SQL authentication bypass attempts 2/3
# ModSec Rule Exclusion: 942310 : Detects chained SQL injection attempts 2/2
# ModSec Rule Exclusion: 942370 : Detects classic SQL injection probings 2/2
# ModSec Rule Exclusion: 942430 : Restricted SQL Character Anomaly Detection (args): # of special characters exceeded (12)
# ModSec Rule Exclusion: 942440 : SQL Comment Sequence Detected.
#
SecRule REQUEST_URI "@endsWith /typo3/index.php" \
        "id:9003300,\
        phase:2,\
        nolog,\
        pass,\
        ctl:ruleRemoveTargetById=920230;ARGS:returnUrl,\
        ctl:ruleRemoveTargetById=932115;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=941320;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=941320;ARGS:data[tt_content][161][bodytext],\
        ctl:ruleRemoveTargetById=941340;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=941340;ARGS:data[tt_content][161][bodytext],\
        ctl:ruleRemoveTargetById=942130;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=942130;ARGS:data[tt_content][161][bodytext],\
        ctl:ruleRemoveTargetById=942200;ARGS:data[tt_content][161][bodytext],\
        ctl:ruleRemoveTargetById=942200;ARGS:icon,\
        ctl:ruleRemoveTargetById=942210;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=942260;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=942260;ARGS:data[tt_content][161][bodytext],\
        ctl:ruleRemoveTargetById=942260;ARGS:tx_extensionmanager_tools_extensionmanagerextensionmanager[__referrer][@request],\
        ctl:ruleRemoveTargetById=942310;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=942370;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=942370;ARGS:icon,\
        ctl:ruleRemoveTargetById=942430;ARGS:data[sys_template][1][config],\
        ctl:ruleRemoveTargetById=942430;ARGS:data[tt_content][161][bodytext],\
        ctl:ruleRemoveTargetById=942430;ARGS:icon,\
        ctl:ruleRemoveTargetById=942430;ARGS:tx_extensionmanager_tools_extensionmanagerextensionmanager[__referrer][@request],\
        ctl:ruleRemoveTargetById=942440;ARGS:data[sys_template][1][config]"


# Important rule exclusion for Typo3 specific backend usage
# ModSec Rule Exclusion: 930110 : Path Traversal Attack (/../)
#
SecRule &REQUEST_COOKIES_NAMES:be_typo_user "@gt 0" \
        "id:'9003310',\
        phase:2,\
        nolog,\
        noauditlog,\
        pass,\
        chain"
                SecRule REQUEST_URI "/typo3/(ajax|alt_doc|alt_clickmenu|tce_file|thumbs)\.php$" \
                        ctl:ruleRemoveTargetById=930110;REQUEST_URI



SecRule &REQUEST_COOKIES_NAMES:be_typo_user "@gt 0" \
        "id:'9003320',\
        phase:2,\
        nolog,\
        noauditlog,\
        pass,\
        chain"
                SecRule REQUEST_METHOD "@pm POST GET" chain
                        SecRule REQUEST_FILENAME "@pmFromFile typo3-backend-files.data" \
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/LEAKAGE/SOURCE_CODE_PHP;RESPONSE_BODY,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/LEAKAGE/SOURCE_CODE_ASP_JSP;RESPONSE_BODY,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/LEAKAGE/SOURCE_CODE;RESPONSE_BODY,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/MALICIOUS_CODE;RESPONSE_BODY,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;TX,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;RESPONSE_BODY,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/COMMAND_INJECTION;ARGS,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/PROTOCOL_VIOLATION/EVASION;RESPONSE_BODY,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/PROTOCOL_VIOLATION/EVASION;ARGS,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/PHP_INJECTION;ARGS,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/LDAP_INJECTION;ARGS,\
                        ctl:ruleRemoveTargetByTag=OWASP_CRS/PROTOCOL_VIOLATION/EVASION;ARGS:returnUrl


SecMarker END-TYPO3
